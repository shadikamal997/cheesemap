// CheeseMap - Production Database Schema
// Phase 1: Complete implementation with geospatial support

generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  extensions = [postgis]
}

// ============================================================================
// ENUMS
// ============================================================================

enum UserRole {
  VISITOR
  SHOP
  FARM
  ADMIN
}

enum BusinessType {
  SHOP
  FARM
  BOTH
}

enum BusinessUserRole {
  OWNER
  MANAGER
  STAFF
}

enum VerificationStatus {
  DRAFT
  PENDING
  UNDER_REVIEW
  VERIFIED
  REJECTED
  SUSPENDED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PAID
  PREPARING
  READY
  SHIPPED
  DELIVERED
  COMPLETED
  CANCELLED
  REFUNDED
}

enum OrderType {
  IN_SHOP
  CLICK_COLLECT
  DELIVERY
}

enum PaymentStatus {
  PENDING
  AUTHORIZED
  CAPTURED
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD
  STRIPE
  TRANSFER
}

enum TourStatus {
  DRAFT
  PENDING
  LIVE
  PAUSED
  ARCHIVED
  REJECTED
}

enum TourType {
  TASTING
  FARM_TOUR
  CAVE_VISIT
  WORKSHOP
  CHEESE_MAKING
  PAIRING
  GUIDED_TOUR
  VISIT
  COMBINATION
}

enum BookingStatus {
  PENDING
  PAID
  CONFIRMED
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum BatchStatus {
  PRODUCTION
  AGING
  READY
  CONVERTED
  DEPLETED
  FAILED
  DISCARDED
  SOLD
}

enum MilkType {
  COW
  GOAT
  SHEEP
  BUFFALO
  MIXED
}

enum UnitType {
  KG
  PIECE
  GRAM_100
  GRAM
  LITER
  PORTION
}

enum ReportedEntityType {
  BUSINESS
  REVIEW
  TOUR
  USER
}

enum ReportStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  DISMISSED
}

enum StampType {
  SHOP_VISIT
  FARM_VISIT
  TOUR_COMPLETED
  CHEESE_TASTED
  PURCHASE
}

enum AchievementRarity {
  COMMON
  RARE
  EPIC
  LEGENDARY
}


// ============================================================================
// AUTHENTICATION & USER MANAGEMENT
// ============================================================================

model User {
  id                      String    @id @default(cuid())
  email                   String    @unique
  passwordHash            String
  role                    UserRole  @default(VISITOR)
  
  // Account status
  isActive                Boolean   @default(true)
  emailVerified           Boolean   @default(false)
  emailVerificationToken  String?
  emailVerificationExpiry DateTime?
  passwordResetToken      String?
  passwordResetExpiry     DateTime?
  
  // Profile
  firstName               String?
  lastName                String?
  phone                   String?
  locale                  String    @default("fr")
  timezone                String    @default("Europe/Paris")
  avatarUrl               String?
  
  // Timestamps
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  lastLoginAt             DateTime?
  
  // Relations
  sessions                Session[]
  refreshTokens           RefreshToken[]
  businessStaff           BusinessUser[]
  ownedBusiness           Business?  @relation("BusinessOwner")
  orders                  Order[]
  bookings                TourBooking[]
  passport                Passport?
  reviews                 Review[]
  savedPlaces             SavedPlace[]
  moderationReports       ModerationReport[]
  auditLogs               AuditLog[]
  verifiedBy              VerificationRequest[] @relation("VerifiedBy")
  approvedTours           Tour[] @relation("TourApprover")
  fileUploads             FileUpload[]
  
  @@index([email])
  @@index([role])
  @@map("users")
}

model Session {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tokenHash   String   @unique
  ipAddress   String?
  userAgent   String?
  expiresAt   DateTime
  
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
  @@map("sessions")
}

model RefreshToken {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  tokenHash String   @unique
  expiresAt DateTime
  revoked   Boolean  @default(false)
  
  createdAt DateTime @default(now())
  
  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// ============================================================================
// BUSINESS PROFILES
// ============================================================================

model Business {
  id                      String              @id @default(cuid())
  ownerId                 String              @unique
  owner                   User                @relation("BusinessOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  type                    BusinessType
  legalName               String
  displayName             String
  siret                   String              @unique
  description             String?
  
  // Address (France only)
  addressLine1            String
  addressLine2            String?
  city                    String
  postalCode              String
  region                  String
  
  // Geospatial (indexed)
  latitude                Float
  longitude               Float
  
  // Contact
  phone                   String?
  email                   String?
  website                 String?
  
  // Stripe Connect
  stripeAccountId         String?
  
  // Verification
  verificationStatus      VerificationStatus  @default(DRAFT)
  verifiedAt              DateTime?
  verifiedBy              String?
  rejectionReason         String?
  isVisible               Boolean             @default(false)
  
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt
  
  // Relations
  staff                   BusinessUser[]
  hours                   BusinessHours[]
  images                  BusinessImage[]
  inventory               ShopInventory[]
  batches                 FarmBatch[]
  orders                  Order[]
  tours                   Tour[]
  deliverySettings        DeliverySettings?
  verificationRequests    VerificationRequest[]
  specialties             BusinessSpecialty[]
  reviews                 Review[]
  passportStamps          PassportStamp[]
  savedBy                 SavedPlace[]
  
  @@index([latitude, longitude])
  @@index([verificationStatus, type])
  @@index([region])
  @@map("businesses")
}

model BusinessUser {
  id          String            @id @default(cuid())
  businessId  String
  business    Business          @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  role        BusinessUserRole  @default(STAFF)
  permissions Json?
  
  invitedAt   DateTime          @default(now())
  acceptedAt  DateTime?
  status      String            @default("pending")
  
  createdAt   DateTime          @default(now())
  
  @@unique([businessId, userId])
  @@map("business_users")
}

model BusinessHours {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  dayOfWeek   Int
  openTime    String?
  closeTime   String?
  isClosed    Boolean  @default(false)
  
  @@unique([businessId, dayOfWeek])
  @@map("business_hours")
}

model BusinessImage {
  id           String   @id @default(cuid())
  businessId   String
  business     Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  url          String
  caption      String?
  isPrimary    Boolean  @default(false)
  displayOrder Int      @default(0)
  
  createdAt    DateTime @default(now())
  
  @@map("business_images")
}

model BusinessSpecialty {
  id          String   @id @default(cuid())
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  cheeseName  String
  isSignature Boolean  @default(false)
  displayOrder Int     @default(0)
  
  @@unique([businessId, cheeseName])
  @@map("business_specialties")
}

// ============================================================================
// SHOP INVENTORY (SKU-based)
// ============================================================================

model ShopInventory {
  id                    String   @id @default(cuid())
  businessId            String
  business              Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  cheeseName            String
  cheeseType            String?
  regionOfOrigin        String?
  producerName          String?
  isAop                 Boolean  @default(false)
  isBio                 Boolean  @default(false)
  milkType              MilkType?
  
  sku                   String   @unique
  pricePerUnit          Float
  unitType              UnitType
  stockQuantity         Float    @default(0)
  lowStockThreshold     Float    @default(0)
  
  isAvailable           Boolean  @default(true)
  isDeliveryAvailable   Boolean  @default(false)
  
  description           String?
  tastingNotes          String?
  pairingSuggestions    String?
  imageUrl              String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  orderItems            OrderItem[]
  reservations          InventoryReservation[]
  
  @@index([businessId])
  @@index([isAvailable])
  @@map("shop_inventory")
}

model InventoryReservation {
  id             String   @id @default(cuid())
  productId      String
  product        ShopInventory @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  quantity       Float
  reservedForType String
  reservedForId  String
  expiresAt      DateTime?
  status         String   @default("active")
  
  createdAt      DateTime @default(now())
  
  @@map("inventory_reservations")
}

// ============================================================================
// FARM PRODUCTION (Batch-based)
// ============================================================================

model FarmBatch {
  id                String           @id @default(cuid())
  businessId        String
  business          Business         @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  batchNumber       String
  cheeseName        String
  cheeseType        String?
  milkType          MilkType?
  
  productionDate    DateTime
  agingStartDate    DateTime?
  minimumAgeDays    Int              @default(0)
  targetAgeDays     Int?
  
  initialQuantityKg Float
  currentQuantityKg Float
  pricePerKg        Float
  
  quantityProduced  Float
  quantityRemaining Float
  unitType          UnitType
  
  location          String?
  temperature       Float?
  humidity          Float?
  
  status            BatchStatus      @default(PRODUCTION)
  
  notes             String?
  
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  
  agingLogs         AgingLog[]
  
  @@unique([businessId, batchNumber])
  @@index([businessId, status])
  @@map("farm_batches")
}

model AgingLog {
  id          String    @id @default(cuid())
  batchId     String
  batch       FarmBatch @relation(fields: [batchId], references: [id], onDelete: Cascade)
  
  loggedAt    DateTime  @default(now())
  ageDays     Int?
  temperature Float?
  humidity    Float?
  weightKg    Float?
  notes       String?
  photos      Json?
  loggedBy    String
  
  @@index([batchId, loggedAt])
  @@map("aging_logs")
}

// ============================================================================
// ORDERS & COMMERCE
// ============================================================================

model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  businessId      String
  business        Business    @relation(fields: [businessId], references: [id])
  
  customerId      String?
  customer        User?       @relation(fields: [customerId], references: [id])
  
  customerName    String
  customerEmail   String?
  customerPhone   String?
  
  orderType       OrderType?
  deliveryMethod  String?
  deliveryNotes   String?
  status          OrderStatus @default(PENDING)
  
  subtotal        Float
  taxRate         Float       @default(0.055)
  taxAmount       Float       @default(0)
  deliveryFee     Float       @default(0)
  packagingFee    Float       @default(0)
  total           Float
  totalAmount     Float
  currency        String      @default("EUR")
  
  paymentMethod   PaymentMethod?
  paymentStatus   PaymentStatus @default(PENDING)
  refundStatus    String?
  
  notes           String?
  cancelledBy     String?
  cancellationReason String?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  completedAt     DateTime?
  cancelledAt     DateTime?
  
  items           OrderItem[]
  deliveryAddress DeliveryAddress?
  payment         Payment?
  
  @@index([businessId, status])
  @@index([customerId, createdAt])
  @@index([orderNumber])
  @@map("orders")
}

model OrderItem {
  id           String        @id @default(cuid())
  orderId      String
  order        Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  inventoryId  String
  inventory    ShopInventory @relation(fields: [inventoryId], references: [id])
  
  itemName     String
  itemDescription String?
  quantity     Float
  pricePerUnit Float
  subtotal     Float
  unitType     UnitType
  unitPrice    Float
  lineTotal    Float
  notes        String?
  
  @@map("order_items")
}

model DeliveryAddress {
  id                  String   @id @default(cuid())
  orderId             String   @unique
  order               Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  recipientName       String
  recipientPhone      String
  addressLine1        String
  addressLine2        String?
  city                String
  postalCode          String
  countryCode         String
  
  deliveryInstructions String?
  trackingNumber      String?
  carrier             String?
  shippedAt           DateTime?
  deliveredAt         DateTime?
  deliveryProofUrl    String?
  
  @@map("delivery_addresses")
}

model Payment {
  id                      String        @id @default(cuid())
  orderId                 String?       @unique
  order                   Order?        @relation(fields: [orderId], references: [id])
  
  bookingId               String?       @unique
  booking                 TourBooking?  @relation(fields: [bookingId], references: [id])
  
  amount                  Float
  currency                String        @default("EUR")
  provider                String        @default("STRIPE")
  paymentMethod           PaymentMethod?
  status                  PaymentStatus @default(PENDING)
  
  providerPaymentId       String?
  stripePaymentIntentId   String?
  transactionId           String?
  refundAmount            Float         @default(0)
  refundReason            String?
  paidAt                  DateTime?
  refundedAt              DateTime?
  metadata                Json?
  
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  
  @@map("payments")
}

// ============================================================================
// TOURS & BOOKINGS
// ============================================================================

model Tour {
  id                      String     @id @default(cuid())
  businessId              String
  business                Business   @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  title                   String
  description             String
  tourType                TourType
  durationMinutes         Int
  maxCapacity             Int
  pricePerPerson          Float
  
  language                String     @default("fr")
  additionalLanguages     Json?
  includes                String?
  requirements            String?
  meetingPoint            String?
  cancellationPolicy      String?
  
  status                  TourStatus @default(DRAFT)
  approvalStatus          String     @default("PENDING")
  isActive                Boolean    @default(false)
  requiresAdminApproval   Boolean    @default(true)
  approvedAt              DateTime?
  approvedBy              String?
  approver                User?      @relation("TourApprover", fields: [approvedBy], references: [id])
  
  imageUrl                String?
  
  createdAt               DateTime   @default(now())
  updatedAt               DateTime   @updatedAt
  
  schedules               TourSchedule[]
  bookings                TourBooking[]
  
  @@index([businessId, status])
  @@index([status])
  @@map("tours")
}

model TourSchedule {
  id              String   @id @default(cuid())
  tourId          String
  tour            Tour     @relation(fields: [tourId], references: [id], onDelete: Cascade)
  
  date            DateTime
  startTime       String
  maxCapacity     Int
  maxParticipants Int
  bookedSpots     Int      @default(0)
  isAvailable     Boolean  @default(true)
  priceOverride   Float?
  notes           String?
  
  bookings        TourBooking[]
  
  createdAt       DateTime @default(now())
  
  @@unique([tourId, date, startTime])
  @@index([tourId, date, isAvailable])
  @@map("tour_schedules")
}

model TourBooking {
  id                String        @id @default(cuid())
  bookingNumber     String        @unique
  
  scheduleId        String
  schedule          TourSchedule  @relation(fields: [scheduleId], references: [id])
  
  tourId            String
  tour              Tour          @relation(fields: [tourId], references: [id])
  
  tourScheduleId    String
  customerId        String
  user              User          @relation(fields: [customerId], references: [id])
  
  customerName      String
  customerEmail     String
  customerPhone     String?
  participants      Int
  pricePerPerson    Float
  totalPrice        Float
  
  status            BookingStatus @default(PENDING)
  
  specialRequests   String?
  cancellationReason String?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  cancelledAt       DateTime?
  
  payment           Payment?
  review            Review?
  
  @@index([tourId])
  @@index([customerId, status])
  @@index([bookingNumber])
  @@map("tour_bookings")
}

model Review {
  id              String      @id @default(cuid())
  bookingId       String      @unique
  booking         TourBooking @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  businessId      String
  business        Business @relation(fields: [businessId], references: [id])
  
  rating          Int
  title           String?
  reviewText      String?
  verifiedVisit   Boolean  @default(true)
  helpfulCount    Int      @default(0)
  isVisible       Boolean  @default(true)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([businessId, isVisible, createdAt])
  @@map("reviews")
}

// ============================================================================
// MAP & DISCOVERY
// ============================================================================

model SavedPlace {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  businessId  String
  business    Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  
  @@unique([userId, businessId])
  @@index([userId])
  @@map("saved_places")
}

// ============================================================================
// CHEESE PASSPORT (Gamification)
// ============================================================================

model Passport {
  id                  String          @id @default(cuid())
  userId              String          @unique
  user                User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  totalStamps         Int             @default(0)
  regionsVisited      Int             @default(0)
  totalAopCheeses     Int             @default(0)
  totalFarmsVisited   Int             @default(0)
  totalShopsVisited   Int             @default(0)
  
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  
  stamps              PassportStamp[]
  achievements        UserAchievement[]
  
  @@map("passports")
}

model PassportStamp {
  id          String     @id @default(cuid())
  passportId  String
  passport    Passport   @relation(fields: [passportId], references: [id], onDelete: Cascade)
  
  businessId  String
  business    Business   @relation(fields: [businessId], references: [id])
  
  cheeseName  String?
  region      String
  stampType   StampType
  metadata    Json?
  
  acquiredAt  DateTime   @default(now())
  
  @@index([passportId, acquiredAt])
  @@index([businessId])
  @@map("passport_stamps")
}

model Achievement {
  id                String            @id @default(cuid())
  code              String            @unique
  name              String
  description       String?
  iconUrl           String?
  requirementType   String
  requirementValue  Int
  rarity            AchievementRarity @default(COMMON)
  
  createdAt         DateTime          @default(now())
  
  userAchievements  UserAchievement[]
  
  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  passport      Passport    @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  
  unlockedAt    DateTime    @default(now())
  
  @@unique([userId, achievementId])
  @@map("user_achievements")
}

// ============================================================================
// DELIVERY CONFIGURATION
// ============================================================================

model DeliveryZone {
  id                String   @id @default(cuid())
  countryCode       String   @unique
  countryName       String
  isEnabled         Boolean  @default(false)
  minOrderAmount    Float?
  baseDeliveryFee   Float
  estimatedDaysMin  Int
  estimatedDaysMax  Int
  requiresCustoms   Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@map("delivery_zones")
}

model DeliverySettings {
  id                      String   @id @default(cuid())
  businessId              String   @unique
  business                Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  deliveryEnabled         Boolean  @default(false)
  allowedCountryCodes     Json
  freeDeliveryThreshold   Float?
  packagingFee            Float    @default(0)
  handlingTimeHours       Int      @default(24)
  specialInstructions     String?
  
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  
  @@map("business_delivery_settings")
}

// ============================================================================
// FILE UPLOADS
// ============================================================================

model FileUpload {
  id            String   @id @default(cuid())
  fileKey       String   @unique
  originalName  String
  contentType   String
  fileSize      Int
  folder        String
  entityId      String?
  uploadedById  String
  uploadedBy    User     @relation(fields: [uploadedById], references: [id])
  uploadedAt    DateTime?
  expiresAt     DateTime
  isCompleted   Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  
  @@index([uploadedById])
  @@index([expiresAt])
  @@map("file_uploads")
}

model VerificationRequest {
  id            String   @id @default(cuid())
  businessId    String
  business      Business @relation(fields: [businessId], references: [id], onDelete: Cascade)
  
  requestedBy   String
  status        String   @default("pending")
  documents     Json?
  submittedNotes String?
  reviewNotes   String?
  rejectionReason String?
  
  reviewedBy    String?
  reviewer      User?    @relation("VerifiedBy", fields: [reviewedBy], references: [id])
  reviewedAt    DateTime?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([status, createdAt])
  @@map("verification_requests")
}

model ModerationReport {
  id                  String              @id @default(cuid())
  reporterId          String?
  reporter            User?               @relation(fields: [reporterId], references: [id])
  
  reportedEntityType  ReportedEntityType
  reportedEntityId    String
  reason              String
  description         String
  
  status              ReportStatus        @default(PENDING)
  resolutionNotes     String?
  resolvedBy          String?
  resolvedAt          DateTime?
  
  createdAt           DateTime            @default(now())
  
  @@index([status, createdAt])
  @@map("moderation_reports")
}

model AuditLog {
  id            String   @id @default(cuid())
  adminId       String
  admin         User     @relation(fields: [adminId], references: [id])
  
  action        String
  entityType    String
  entityId      String
  details       Json
  ipAddress     String?
  
  createdAt     DateTime @default(now())
  
  @@index([adminId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}
